<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dye Doxxer (Static)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.png">
  <style>
    html,body{margin:0;padding:0}
    body{
      font-family:'Rubik', sans-serif;
      font-size:20px;
      margin:40px;
      color:#fff;
      background-image:url('background.png');
      background-repeat:no-repeat;
      background-position:center center;
      background-attachment:fixed;
      background-size:cover;
      text-shadow:0 1px 1px rgba(0,0,0,.6);
    }
    .card{
      background-color:rgba(0,0,0,.55);
      padding:20px;
      border-radius:12px;
      margin-top:20px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    label{display:inline-block;width:160px}
    input[type=number]{width:110px;font-size:20px}
    input[type=submit],button,select{
      font-size:22px;padding:10px 18px;cursor:pointer;border-radius:10px;
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);
      color:#fff;
    }
    input[type=submit]:hover,button:hover{background:rgba(255,255,255,.18)}
    .sequence{font-size:24px;margin-top:10px}
    .swatch{display:inline-block;width:50px;height:50px;border:1px solid #fff;margin-left:8px;vertical-align:middle}
    .nav{margin-top:16px;font-size:22px}
    .row{margin-top:8px}
    a, .link {color:#fff;text-decoration:underline;cursor:pointer}
    .pill{display:inline-block;padding:6px 10px;border:1px solid rgba(255,255,255,.25);border-radius:9999px;background:rgba(255,255,255,.1)}
    .mini-btn{font-size:16px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);color:#fff;cursor:pointer}
    .mini-btn:hover{background:rgba(255,255,255,.18)}
    .sw{display:inline-block;width:20px;height:20px;border:1px solid #fff;border-radius:4px;margin-right:8px;vertical-align:middle}
    #visual{box-shadow:0 6px 20px rgba(0,0,0,.35);border-radius:10px}
    .tabs{margin-bottom:8px}
    .tabs button{margin-right:6px}
    /* simple hide/show sections */
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card" style="display:block;max-width:900px">
    <div class="tabs">
      <button id="tab-home">Finder</button>
      <button id="tab-saved">Saved</button>
      <button id="tab-history">History</button>
      <button id="tab-settings">Settings</button>
    </div>

    <!-- =============== HOME / FINDER =============== -->
    <section id="view-home">
      <h2>Dye Doxxer</h2>
      <div class="row">
        <img src="dye_red.png"   alt="Red"   style="width:80px;height:80px;margin-right:8px">
        <img src="dye_green.png" alt="Green" style="width:80px;height:80px;margin-right:8px">
        <img src="dye_blue.png"  alt="Blue"  style="width:80px;height:80px;margin-right:8px">
        <img src="dye_black.png" alt="Black" style="width:80px;height:80px;margin-right:8px">
      </div>

      <form id="finder-form" class="card" style="display:block">
        <div class="row"><label>Target R (0–255):</label><input type="number" name="r" min="0" max="255" required></div>
        <div class="row"><label>Target G (0–255):</label><input type="number" name="g" min="0" max="255" required></div>
        <div class="row"><label>Target B (0–255):</label><input type="number" name="b" min="0" max="255" required></div>
        <div class="row">
          <input type="submit" value="Find Sequence">
          <button type="button" id="btn-save" disabled>Save</button>
        </div>
      </form>

      <div id="result-card" class="card hidden">
        <h3>Result</h3>
        <p class="sequence"><strong>Sequence:</strong> <span id="seq-html"></span></p>
        <p><strong>Final Color:</strong> <span id="final-color-text"></span>
           <span class="swatch" id="final-color-swatch"></span></p>
        <p><strong>Target:</strong> <span id="target-text"></span>
           <span class="swatch" id="target-swatch"></span></p>
        <p><strong>Final Mask:</strong> <span id="final-mask-text"></span></p>
        <p><strong>Difference:</strong> <span id="diff-text"></span></p>

        <button id="play">Play Sequence</button>
        <canvas id="visual" width="300" height="100" style="border:2px solid #fff;margin-top:10px"></canvas>
      </div>
    </section>

    <!-- =============== SAVED =============== -->
    <section id="view-saved" class="hidden">
      <h2>Saved</h2>
      <div id="saved-list"></div>
      <div class="row"><span class="link" id="back-to-home-1">Back</span></div>
    </section>

    <!-- =============== HISTORY =============== -->
    <section id="view-history" class="hidden">
      <h2>History (last 10)</h2>
      <div class="row">
        <label>Filter (e.g. 241,219,29):</label>
        <input type="text" id="hist-filter" style="font-size:18px" placeholder="type to filter…">
      </div>
      <div id="history-list" style="margin-top:10px"></div>
      <div class="row"><span class="link" id="back-to-home-2">Back</span></div>
    </section>

    <!-- =============== SETTINGS =============== -->
    <section id="view-settings" class="hidden">
      <h2>Settings</h2>
      <form id="settings-form">
        <div class="row"><strong>Start (base pixel S):</strong></div>
        <div class="row"><label>Start R:</label><input type="number" id="sr" min="0" max="255" required></div>
        <div class="row"><label>Start G:</label><input type="number" id="sg" min="0" max="255" required></div>
        <div class="row"><label>Start B:</label><input type="number" id="sb" min="0" max="255" required></div>
        <hr style="margin:12px 0;border-color:#777">
        <div class="row"><strong>Dye step parameters</strong></div>
        <div class="row"><label>ADD_VALUE (+):</label><input type="number" id="add" required></div>
        <div class="row"><label>SUB_VALUE (−):</label><input type="number" id="sub" required></div>
        <div class="row"><label>Search MAX_DEPTH:</label><input type="number" id="depth" required></div>
        <div class="row">
          <button type="submit">Save Settings</button>
        </div>
      </form>

      <div class="row"><span class="link" id="back-to-home-3">Back</span></div>
    </section>
  </div>

  <script>
  // ---------------------- Storage helpers ----------------------
  const store = {
    get(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // ---------------------- Defaults (match Flask) ----------------------
  const DEFAULTS = {
    START_RGB: [241, 219, 29],
    ADD_VALUE: 32,
    SUB_VALUE: 16,
    MAX_DEPTH: 48
  };

  // load or init config
  const cfg = store.get('cfg', DEFAULTS);
  // history & saved
  let historyItems = store.get('history', []); // newest last; we’ll slice(-10)
  let savedItems   = store.get('saved', []);

  // ---------------------- Math helpers ----------------------
  const DYES = ["red","green","blue","black"];
  const clamp255 = x => Math.max(0, Math.min(255, x));
  function dyeVector(dye, addVal, subVal){
    if(dye==="red")   return [ addVal, -subVal, -subVal];
    if(dye==="green") return [-subVal,  addVal, -subVal];
    if(dye==="blue")  return [-subVal, -subVal,  addVal];
    if(dye==="black") return [-32, -32, -32];
    return [0,0,0];
  }
  function applyDyeToMask(mask, dye, addVal, subVal){
    const dv = dyeVector(dye, addVal, subVal);
    return [
      clamp255(mask[0] + dv[0]),
      clamp255(mask[1] + dv[1]),
      clamp255(mask[2] + dv[2]),
    ];
  }
  function applyMaskToColor(base, mask){
    return [
      clamp255(Math.round(base[0] * mask[0] / 255)),
      clamp255(Math.round(base[1] * mask[1] / 255)),
      clamp255(Math.round(base[2] * mask[2] / 255)),
    ];
  }
  function manhattan(a, b){ return Math.abs(a[0]-b[0]) + Math.abs(a[1]-b[1]) + Math.abs(a[2]-b[2]); }

  // ---------------------- BFS search over masks ----------------------
  function findSequenceToTarget(target, opts){
    const MAX_DEPTH = (opts && opts.maxDepth != null) ? opts.maxDepth : cfg.MAX_DEPTH;
    const base = (opts && opts.startRGB) || cfg.START_RGB;
    const addVal = (opts && opts.addVal != null) ? opts.addVal : cfg.ADD_VALUE;
    const subVal = (opts && opts.subVal != null) ? opts.subVal : cfg.SUB_VALUE;

    const startMask = [255,255,255];
    const startColor = applyMaskToColor(base, startMask);

    let q = [[startMask, []]];
    let visited = new Set([startMask.toString()]);

    let bestMask = startMask.slice();
    let bestSeq = [];
    let bestColor = startColor.slice();
    let bestDiff = manhattan(bestColor, target);

    while(q.length){
      const [mask, seq] = q.shift();
      if(seq.length > MAX_DEPTH) continue;

      const color = applyMaskToColor(base, mask);
      const diff  = manhattan(color, target);
      if(diff < bestDiff){
        bestDiff = diff;
        bestMask = mask.slice();
        bestSeq  = seq.slice();
        bestColor= color.slice();
        if(bestDiff === 0) break;
      }

      for(const dye of DYES){
        const nxt = applyDyeToMask(mask, dye, addVal, subVal);
        const key = nxt.toString();
        if(!visited.has(key)){
          visited.add(key);
          q.push([nxt, seq.concat(dye)]);
        }
      }
    }
    return { steps: bestSeq, finalMask: bestMask, finalColor: bestColor, diff: bestDiff };
  }

  // ---------------------- UI helpers ----------------------
  function prettySequence(seq){
    if(!seq || !seq.length) return "No dyes applied";
    const colors = { red:"#ff4d4d", green:"#4dff4d", blue:"#4da6ff", black:"#ffffff" };
    let out = [];
    let i=0;
    while(i<seq.length){
      const token = seq[i];
      let n=1; i++;
      while(i<seq.length && seq[i]===token){ n++; i++; }
      const hex = colors[token] || "#fff";
      const style = `color:${hex}; font-size:22px; margin-right:12px; text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;`;
      out.push(`<span style="${style}">${n}x ${token}</span>`);
    }
    return out.join(" ");
  }
  function setSwatch(el, rgb){ el.style.background = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`; }

  // ---------------------- Tabs ----------------------
  const viewHome    = document.getElementById('view-home');
  const viewSaved   = document.getElementById('view-saved');
  const viewHistory = document.getElementById('view-history');
  const viewSettings= document.getElementById('view-settings');
  function show(id){
    for(const v of [viewHome,viewSaved,viewHistory,viewSettings]) v.classList.add('hidden');
    id.classList.remove('hidden');
  }
  document.getElementById('tab-home').onclick    = ()=>show(viewHome);
  document.getElementById('tab-saved').onclick   = ()=>{ renderSaved(); show(viewSaved); };
  document.getElementById('tab-history').onclick = ()=>{ renderHistory(); show(viewHistory); };
  document.getElementById('tab-settings').onclick= ()=>{ loadSettingsForm(); show(viewSettings); };
  document.getElementById('back-to-home-1').onclick = ()=>show(viewHome);
  document.getElementById('back-to-home-2').onclick = ()=>show(viewHome);
  document.getElementById('back-to-home-3').onclick = ()=>show(viewHome);

  // ---------------------- Finder logic ----------------------
  const form = document.getElementById('finder-form');
  const resultCard = document.getElementById('result-card');
  const btnSave = document.getElementById('btn-save');

  let lastResult = null;

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const r = parseInt(form.r.value,10);
    const g = parseInt(form.g.value,10);
    const b = parseInt(form.b.value,10);
    const target = [isNaN(r)?0:r, isNaN(g)?0:g, isNaN(b)?0:b];

    const res = findSequenceToTarget(target);
    lastResult = {
      sequenceHTML: prettySequence(res.steps),
      rawSteps: res.steps,
      finalMask: res.finalMask,
      finalColor: res.finalColor,
      target: target,
      diff: res.diff
    };

    // render
    document.getElementById('seq-html').innerHTML = lastResult.sequenceHTML;
    document.getElementById('final-color-text').textContent = `(${lastResult.finalColor[0]}, ${lastResult.finalColor[1]}, ${lastResult.finalColor[2]})`;
    setSwatch(document.getElementById('final-color-swatch'), lastResult.finalColor);
    document.getElementById('target-text').textContent = `(${target[0]}, ${target[1]}, ${target[2]})`;
    setSwatch(document.getElementById('target-swatch'), target);
    document.getElementById('final-mask-text').textContent = `(${lastResult.finalMask[0]}, ${lastResult.finalMask[1]}, ${lastResult.finalMask[2]})`;
    document.getElementById('diff-text').textContent = lastResult.diff;

    resultCard.classList.remove('hidden');
    btnSave.disabled = false;

    // history (limit 10)
    historyItems.push({
      sequence: lastResult.sequenceHTML,
      final_mask: lastResult.finalMask,
      final_color: lastResult.finalColor,
      target: target,
      diff: lastResult.diff,
      ts: new Date().toISOString()
    });
    historyItems = historyItems.slice(-10);
    store.set('history', historyItems);
  });

  btnSave.addEventListener('click', ()=>{
    if(!lastResult) return;
    savedItems.push({
      sequence: lastResult.sequenceHTML,
      final_mask: lastResult.finalMask,
      final_color: lastResult.finalColor,
      target: lastResult.target,
      diff: lastResult.diff
    });
    store.set('saved', savedItems);
    btnSave.disabled = true;
    alert('Saved!');
  });

  // Play Sequence canvas
  document.getElementById('play').addEventListener('click', ()=>{
    if(!lastResult) return;
    const steps = lastResult.rawSteps.slice();
    const c = document.getElementById('visual');
    const ctx = c.getContext('2d');

    const startRGB = cfg.START_RGB.slice();
    let mask = [255,255,255];
    let cur = applyMaskToColor(startRGB, mask);
    paint(cur);

    let i = 0;
    const t = setInterval(()=>{
      if(i>=steps.length){ clearInterval(t); return; }
      const d = dyeVector(steps[i++], cfg.ADD_VALUE, cfg.SUB_VALUE);
      mask = [clamp255(mask[0]+d[0]), clamp255(mask[1]+d[1]), clamp255(mask[2]+d[2])];
      cur = applyMaskToColor(startRGB, mask);
      paint(cur);
    }, 420);

    function paint(rgb){
      ctx.fillStyle = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
      ctx.fillRect(0,0,c.width,c.height);
    }
  });

  // ---------------------- Saved ----------------------
  function renderSaved(){
    const box = document.getElementById('saved-list');
    box.innerHTML = '';
    if(!savedItems.length){ box.innerHTML = '<p>No saved items.</p>'; return; }
    savedItems.forEach((it, idx)=>{
      const wrap = document.createElement('div');
      wrap.style.borderBottom = '1px solid #fff';
      wrap.style.marginBottom = '14px';
      wrap.style.paddingBottom = '10px';
      wrap.innerHTML = `
        <div class="sequence"><strong>Sequence:</strong> ${it.sequence}</div>
        <div><strong>Final Color:</strong> (${it.final_color[0]}, ${it.final_color[1]}, ${it.final_color[2]})
          <span class="swatch" style="background: rgb(${it.final_color[0]},${it.final_color[1]},${it.final_color[2]});"></span>
        </div>
        <div><strong>Target:</strong> (${it.target[0]}, ${it.target[1]}, ${it.target[2]})
          <span class="swatch" style="background: rgb(${it.target[0]},${it.target[1]},${it.target[2]});"></span>
        </div>
        <div><strong>Final Mask:</strong> (${it.final_mask[0]}, ${it.final_mask[1]}, ${it.final_mask[2]})</div>
        <div><strong>Diff:</strong> ${it.diff}</div>
        <button class="mini-btn" data-del="${idx}">Delete</button>
      `;
      box.appendChild(wrap);
    });
    // delete handlers
    box.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = parseInt(btn.getAttribute('data-del'),10);
        if(!isNaN(i)){
          savedItems.splice(i,1);
          store.set('saved', savedItems);
          renderSaved();
        }
      };
    });
  }

  // ---------------------- History ----------------------
  function renderHistory(){
    const q = document.getElementById('hist-filter').value.trim();
    const box = document.getElementById('history-list');
    box.innerHTML = '';
    let items = historyItems.slice().reverse(); // newest first
    if(q) items = items.filter(it => (`${it.target}`).includes(q));
    if(!items.length){ box.innerHTML = '<p>No history yet.</p>'; return; }
    items.forEach(it=>{
      const wrap = document.createElement('div');
      wrap.style.borderBottom = '1px solid #fff';
      wrap.style.marginBottom = '14px';
      wrap.style.paddingBottom = '10px';
      wrap.innerHTML = `
        <div class="sequence"><strong>Sequence:</strong> ${it.sequence}</div>
        <div><strong>Target:</strong> (${it.target[0]}, ${it.target[1]}, ${it.target[2]})
          <span class="swatch" style="background: rgb(${it.target[0]},${it.target[1]},${it.target[2]});"></span>
        </div>
        <div><strong>Final Color:</strong> (${it.final_color[0]}, ${it.final_color[1]}, ${it.final_color[2]})
          <span class="swatch" style="background: rgb(${it.final_color[0]},${it.final_color[1]},${it.final_color[2]});"></span>
        </div>
        <div><strong>Final Mask:</strong> (${it.final_mask[0]}, ${it.final_mask[1]}, ${it.final_mask[2]})</div>
        <div><strong>Diff:</strong> ${it.diff}</div>
      `;
      box.appendChild(wrap);
    });
  }
  document.getElementById('hist-filter').addEventListener('input', renderHistory);

  // ---------------------- Settings ----------------------
  function loadSettingsForm(){
    document.getElementById('sr').value = cfg.START_RGB[0];
    document.getElementById('sg').value = cfg.START_RGB[1];
    document.getElementById('sb').value = cfg.START_RGB[2];
    document.getElementById('add').value = cfg.ADD_VALUE;
    document.getElementById('sub').value = cfg.SUB_VALUE;
    document.getElementById('depth').value = cfg.MAX_DEPTH;
  }
  document.getElementById('settings-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    cfg.START_RGB = [parseInt(sr.value,10), parseInt(sg.value,10), parseInt(sb.value,10)].map(x=>isNaN(x)?0:x);
    cfg.ADD_VALUE = parseInt(add.value,10) || 0;
    cfg.SUB_VALUE = parseInt(sub.value,10) || 0;
    cfg.MAX_DEPTH = parseInt(depth.value,10) || 0;
    store.set('cfg', cfg);
    alert('Settings saved');
    show(viewHome);
  });

  // land on Finder by default
  show(viewHome);
  </script>
</body>
</html>

